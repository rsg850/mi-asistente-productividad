<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Tareas ‚Äì Mi Asistente de Productividad</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 300; }
    .header p  { opacity: 0.9; font-size: 1.1em; }
    .form-container { padding: 40px; }
    .form-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border-left: 4px solid #667eea;
    }
    .section-title { font-size: 1.3em; font-weight: 600; color: #333; margin-bottom: 20px; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    input, select, textarea {
      width: 100%; padding: 12px 15px; border: 2px solid #e1e5e9;
      border-radius: 10px; font-size: 15px; transition: border-color 0.3s;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
    textarea { min-height: 100px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .submit-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border: none; padding: 18px 40px; border-radius: 50px;
      font-size: 18px; font-weight: 600; cursor: pointer; width: 100%;
      margin-top: 10px; transition: transform 0.3s, box-shadow 0.3s;
    }
    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .message {
      padding: 15px; border-radius: 10px; margin-top: 20px;
      display: none; animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .error-message {
      background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
    }
    .success-message {
      background: #d4edda; color: #155724; border: 1px solid #c3e6cb;
    }
    .datetime-group { display: grid; grid-template-columns: 1fr auto; gap: 10px; }
    .calendar-section {
      background: #e3f2fd; padding: 20px; border-radius: 15px;
      border-left: 4px solid #2196F3; margin-top: 20px;
    }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
    .checkbox-item { display: flex; align-items: center; gap: 5px; }
    .checkbox-item input { width: auto; margin: 0; }
    .loading {
      display: inline-block; width: 20px; height: 20px;
      border: 3px solid #f3f3f3; border-top: 3px solid #667eea;
      border-radius: 50%; animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin { 0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);} }
    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
      .form-container { padding: 20px; }
      .header h1 { font-size: 2em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìã Mi Asistente de Productividad</h1>
      <p>Sistema completo de gesti√≥n de tareas conectado a Notion y Google Calendar</p>
    </div>
    <div class="form-container">
      <form id="taskForm">
        <!-- Informaci√≥n B√°sica -->
        <div class="form-section">
          <div class="section-title">üìù Informaci√≥n B√°sica</div>
          <div class="form-group">
            <label for="titulo">¬øQu√© necesitas hacer? *</label>
            <input type="text" id="titulo" name="titulo" placeholder="Ej: Revisar informes" required maxlength="100">
          </div>
          <div class="form-group">
            <label for="descripcion">Descripci√≥n detallada</label>
            <textarea id="descripcion" name="descripcion" placeholder="A√±ade m√°s detalles..." maxlength="500"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="estado">üìä Estado</label>
              <select id="estado" name="estado">
                <option value="Sin empezar">üî¥ Sin empezar</option>
                <option value="En progreso">üü° En progreso</option>
                <option value="Listo">üü¢ Listo</option>
              </select>
            </div>
            <div class="form-group">
              <label for="prioridad">üî• Prioridad</label>
              <select id="prioridad" name="prioridad">
                <option value="Media">üü° Media</option>
                <option value="Alta">üî¥ Alta</option>
                <option value="Baja">üü¢ Baja</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Categorizaci√≥n -->
        <div class="form-section">
          <div class="section-title">üóÇÔ∏è Categorizaci√≥n</div>
          <div class="form-group">
            <label for="area">üè¢ √Årea</label>
            <select id="area" name="area">
              <option value="">Seleccionar √°rea...</option>
              <option value="Profesional">üíº Profesional</option>
              <option value="Acad√©mico">üéì Acad√©mico</option>
              <option value="Personal">üòä Personal</option>
              <option value="Formaci√≥n">üìö Formaci√≥n</option>
              <option value="Huerta">üå± Huerta</option>
            </select>
          </div>
          <div class="form-group">
            <label>üè∑Ô∏è Tipo de tarea</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="tipo_personal" name="tipo_tarea" value="Personal">
                <label for="tipo_personal">Personal</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="tipo_trabajo" name="tipo_tarea" value="Trabajo">
                <label for="tipo_trabajo">Trabajo</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="tipo_social" name="tipo_tarea" value="Social">
                <label for="tipo_social">Social</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Fechas y Google Calendar -->
        <div class="form-section">
          <div class="section-title">üìÖ Fechas y Google Calendar</div>
          <div class="form-group">
            <label for="fecha_limite">‚è∞ Fecha l√≠mite</label>
            <div class="datetime-group">
              <input type="date" id="fecha_limite" name="fecha_limite">
              <input type="time" id="hora_limite" name="hora_limite">
            </div>
          </div>
          <div class="calendar-section">
            <div style="display:flex;align-items:center;gap:10px;">
              <input type="checkbox" id="add_to_calendar" name="add_to_calendar">
              <label for="add_to_calendar" style="margin:0;font-weight:600;">A√±adir evento a Google Calendar</label>
            </div>
            <div id="calendarOptions" style="display:none;margin-top:15px;">
              <label style="font-size:0.9em;color:#666;">Recordatorios:</label>
              <div class="checkbox-group" style="margin-top:5px;">
                <div class="checkbox-item">
                  <input type="checkbox" id="recordatorio_2h" name="recordatorio_2h">
                  <label for="recordatorio_2h">2 horas antes</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="recordatorio_custom" name="recordatorio_custom">
                  <label for="recordatorio_custom">Personalizado</label>
                </div>
              </div>
              <div id="customReminderOptions" style="display:none;margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <input type="date" id="recordatorio_fecha" name="recordatorio_fecha">
                <input type="time" id="recordatorio_hora" name="recordatorio_hora">
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">‚ú® Crear Tarea</button>
      </form>

      <div id="successMessage" class="message success-message"></div>
      <div id="errorMessage" class="message error-message"></div>
    </div>
  </div>

  <script>
    const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbxdSL2hrdAO8AnnRAdrZhgizjO9keNTMpPjNXJ8AoWAEj0z0fB_qwxaC-MAy24PLCo1-Q/exec';

    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
      document.getElementById('taskForm').addEventListener('submit', handleFormSubmit);
      document.getElementById('add_to_calendar').addEventListener('change', toggleCalendarOptions);
      document.getElementById('recordatorio_custom').addEventListener('change', toggleCustomReminder);
      // poner fecha m√≠nima de hoy
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('fecha_limite').setAttribute('min', today);
    }

    function toggleCalendarOptions(e) {
      document.getElementById('calendarOptions').style.display = e.target.checked ? 'block' : 'none';
    }
    function toggleCustomReminder(e) {
      document.getElementById('customReminderOptions').style.display = e.target.checked ? 'grid' : 'none';
    }

    async function handleFormSubmit(e) {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      const ok  = document.getElementById('successMessage');
      const err = document.getElementById('errorMessage');

      if (!validateForm()) return;

      btn.disabled = true;
      btn.innerHTML = 'Creando... <div class="loading"></div>';
      ok.style.display = err.style.display = 'none';

      const data = prepareFormData();
      try {
        // primero intento silent (no-cors)
        await fetch(WEBHOOK_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(data) });
        // luego obtengo respuesta real
        const result = await fetchWithRetry(WEBHOOK_URL, { method:'POST', body: JSON.stringify(data) });
        if (!result.success) throw new Error(result.error || 'Error desconocido');
        showSuccess(result);
        document.getElementById('taskForm').reset();
      } catch (e) {
        console.error(e);
        showError(e.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '‚ú® Crear Tarea';
      }
    }

    function validateForm() {
      const t = document.getElementById('titulo').value.trim();
      if (!t) { showError('T√≠tulo requerido'); return false; }
      if (t.length < 3) { showError('T√≠tulo demasiado corto'); return false; }
      return true;
    }

    function prepareFormData() {
      let fechaComp = null;
      const f = document.getElementById('fecha_limite').value;
      const h = document.getElementById('hora_limite').value;
      if (f) fechaComp = h ? `${f} ${h}` : `${f} 09:00`;

      const tipos = Array.from(document.querySelectorAll('input[name="tipo_tarea"]:checked'))
                         .map(cb => cb.value);

      return {
        action: 'createTask',
        titulo:       document.getElementById('titulo').value.trim(),
        descripcion:  document.getElementById('descripcion').value.trim(),
        estado:       document.getElementById('estado').value,
        prioridad:    document.getElementById('prioridad').value,
        area:         document.getElementById('area').value,
        nivel_esfuerzo: '',  // si lo necesitas, agr√©galo aqu√≠
        fecha_limite: fechaComp,
        tipo_tarea:   tipos,
        add_to_calendar:    document.getElementById('add_to_calendar').checked,
        recordatorio_2h:    document.getElementById('recordatorio_2h').checked,
        recordatorio_custom:document.getElementById('recordatorio_custom').checked,
        recordatorio_fecha: document.getElementById('recordatorio_fecha').value,
        recordatorio_hora:  document.getElementById('recordatorio_hora').value
      };
    }

    async function fetchWithRetry(url, options, retries=3) {
      for (let i=0; i<retries; i++) {
        try {
          const res = await fetch(url, { ...options, redirect:'follow' });
          if (!res.ok && i < retries-1) {
            await new Promise(r => setTimeout(r, 1000*(i+1)));
            continue;
          }
          return await res.json();
        } catch {
          if (i === retries-1) throw;
          await new Promise(r => setTimeout(r, 1000*(i+1)));
        }
      }
    }

    function showSuccess(r) {
      const ok = document.getElementById('successMessage');
      let msg = '‚úÖ ¬°Tarea creada!';
      if (r.notionUrl)   msg += ` <a href="${r.notionUrl}" target="_blank">Ver Notion ‚Üí</a>`;
      if (r.calendarUrl) msg += ` | <a href="${r.calendarUrl}" target="_blank">Ver Calendar ‚Üí</a>`;
      ok.innerHTML = msg;
      ok.style.display = 'block';
      setTimeout(() => ok.style.display = 'none', 10000);
    }

    function showError(text) {
      const err = document.getElementById('errorMessage');
      err.textContent = `‚ùå ${text}`;
      err.style.display = 'block';
      setTimeout(() => err.style.display = 'none', 5000);
    }
  </script>
</body>
</html>
