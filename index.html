<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Centro de Productividad</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar-icalendar@6.1.14/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.3/dist/cal-heatmap.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.3/dist/cal-heatmap.css">

    <style>
        :root {
            --primary-color: #00A99D;
            --secondary-color: #0077B6;
            --background-color: #F8F9FA;
            --form-background: #ffffff;
            --text-color: #212529;
            --label-color: #495057;
            --border-color: #DEE2E6;
            --success-color: #198754;
            --error-color: #DC3545;
            --delete-color: #e53e3e;
            --archive-color: #6c757d;
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
            --border-radius: 12px;
            --status-pending-bg: #FEF3C7;
            --status-pending-text: #92400E;
            --status-progress-bg: #DBEAFE;
            --status-progress-text: #1E40AF;
            --status-done-bg: #D1FAE5;
            --status-done-text: #065F46;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; padding: 20px; }
        .container { max-width: 900px; margin: 20px auto; background: var(--form-background); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 30px; text-align: center; }
        h1, h2, h3, h4 { font-weight: 700; }
        .main-content { padding: 30px 40px; }
        .tab-navigation { display: flex; flex-wrap: wrap; border-bottom: 2px solid var(--border-color); margin-bottom: 30px; }
        .tab-btn { padding: 15px 25px; cursor: pointer; background: none; border: none; font-size: 1.1em; font-weight: 600; color: var(--label-color); transition: all 0.3s; border-bottom: 3px solid transparent; flex-shrink: 0; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .section-title { font-size: 1.4em; color: var(--primary-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #F1F3F5; display: flex; align-items: center; }
        .section-title svg { margin-right: 12px; stroke: var(--primary-color); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--label-color); font-size: 0.95em; }
        input, select, textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; font-family: 'Inter', sans-serif; transition: all 0.3s; background-color: #FDFDFD; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 169, 157, 0.2); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .submit-btn, .action-btn { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 10px; }
        .submit-btn:disabled { background: #BDBDBD; cursor: not-allowed; }
        .message { padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; }
        .error-message { background: #FFF3F3; color: var(--error-color); border: 1px solid var(--error-color); }
        .loading-container::after { content: 'Cargando...'; display: block; text-align: center; padding: 40px; font-size: 1.2em; color: var(--label-color); }
        .hidden { display: none; }
        .sub-tab-navigation { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .sub-tab-btn { padding: 10px 15px; font-weight: 600; cursor: pointer; border: none; background: none; border-bottom: 3px solid transparent; }
        .sub-tab-btn.active { color: var(--secondary-color); border-bottom-color: var(--secondary-color); }
        .sub-tab-content { display: none; }
        .sub-tab-content.active { display: block; }
        .project-progress-item { margin-bottom: 15px; }
        .project-info-header { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; font-weight: 600; cursor: pointer; padding: 10px; border-radius: 8px; transition: background-color 0.2s; }
        .project-info-header:hover { background-color: #f1f3f5; }
        .progress-bar { width: 100%; background-color: #e9ecef; border-radius: 50px; height: 10px; margin-top: 5px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background-color: var(--primary-color); border-radius: 50px; transition: width 0.5s ease-in-out; }
        .project-tasks-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out, padding 0.5s ease-out; padding: 0 20px; margin-top: 10px; }
        .project-tasks-details.visible { max-height: 2000px; padding: 15px 20px; border-top: 1px solid var(--border-color); }
        .tasks-by-status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .status-column h4 { font-size: 1.1em; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid; }
        .status-column.status-pending h4 { border-color: var(--status-pending-text); color: var(--status-pending-text); }
        .status-column.status-progress h4 { border-color: var(--status-progress-text); color: var(--status-progress-text); }
        .status-column.status-done h4 { border-color: var(--status-done-text); color: var(--status-done-text); }
        .status-column ul { list-style: none; padding: 0; }
        .status-column li { background-color: #f8f9fa; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 0.95em; cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s; }
        .status-column li:hover { background-color: #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .project-chart-container { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
        #heatmap-container { grid-column: 1 / -1; } /* Ocupa todo el ancho */
        .kpi-card { background-color: #fff; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; }
        .kpi-value { font-size: 2.5em; font-weight: 700; color: var(--primary-color); }
        .kpi-label { font-size: 1em; color: var(--label-color); margin-top: 5px; }
        .chart-card { background-color: #fff; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .dist-buttons { display:flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
        .dist-buttons button { background-color: #f1f3f5; border: 1px solid var(--border-color); padding: 8px 15px; border-radius: 50px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .dist-buttons button.active { background-color: var(--secondary-color); color: white; border-color: var(--secondary-color); }
        .cal-heatmap .graph-rect { shape-rendering: geometricPrecision; }
        .cal-heatmap .q1 { fill: #cce8e6; }
        .cal-heatmap .q2 { fill: #80c7c1; }
        .cal-heatmap .q3 { fill: #40a69d; }
        .cal-heatmap .q4 { fill: #00857a; }
        .cal-heatmap .q5 { fill: #00544d; }
        
        @media (max-width: 768px) {
            .main-content { padding: 15px; }
            .form-row, .analysis-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Centro de Productividad</h1>
        </header>

        <nav class="tab-navigation">
            <button class="tab-btn active" data-tab="asistente">‚ûï Asistente</button>
            <button class="tab-btn" data-tab="gestor">üìã Gestor</button>
            <button class="tab-btn" data-tab="proyectos">üóÇÔ∏è Proyectos</button>
            <button class="tab-btn" data-tab="agenda">üóìÔ∏è Agenda</button>
            <button class="tab-btn" data-tab="analisis">üìä An√°lisis</button>
            <button class="tab-btn" data-tab="ajustes">‚öôÔ∏è Ajustes</button>
        </nav>

        <main class="main-content">
            <!-- PESTA√ëA 1: ASISTENTE (FORMULARIO) -->
            <div id="asistente" class="tab-content active">
                <form id="taskForm" novalidate>
                    <section class="form-section">
                        <h2 class="section-title"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>Informaci√≥n de la Tarea</h2>
                        <div class="form-group">
                            <label for="titulo">¬øQu√© necesitas hacer? *</label>
                            <input type="text" id="titulo" name="titulo" required>
                        </div>
                        <div class="form-group">
                            <label for="descripcion">Descripci√≥n</label>
                            <textarea id="descripcion" name="descripcion"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="estado">Estado</label>
                                <select id="estado" name="estado"></select>
                            </div>
                            <div class="form-group">
                                <label for="prioridad">Prioridad</label>
                                <select id="prioridad" name="prioridad"></select>
                            </div>
                        </div>
                    </section>
                    <section class="form-section">
                        <h2 class="section-title"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>Categorizaci√≥n</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="area">√Årea</label>
                                <select id="area" name="area"><option value="">Cargando √°reas...</option></select>
                                <input type="text" id="area_other" name="area_other" class="hidden" style="margin-top: 10px;" placeholder="Escribe el √°rea personalizada">
                            </div>
                            <div class="form-group">
                                <label for="proyecto_id">Proyecto</label>
                                <select id="proyecto_id" name="proyecto_id"><option value="none">Cargando...</option></select>
                            </div>
                        </div>
                    </section>
                    <section class="form-section">
                        <h2 class="section-title"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>Fechas y Recordatorios</h2>
                        <div class="event-type-selector">
                            <input type="radio" id="type-puntual" name="eventType" value="puntual" checked>
                            <label for="type-puntual">Tarea Puntual</label>
                            <input type="radio" id="type-rango" name="eventType" value="rango">
                            <label for="type-rango">Evento de Varios D√≠as</label>
                            <input type="radio" id="type-recurrente" name="eventType" value="recurrente">
                            <label for="type-recurrente">Actividad Recurrente</label>
                        </div>
                        <div id="fecha-puntual-section">
                            <p class="form-subtitle">Para tareas en un d√≠a concreto con hora de inicio y fin.</p>
                            <div class="form-group">
                                <div class="datetime-group">
                                    <input type="date" id="fecha_limite" name="fecha_limite" title="Fecha l√≠mite">
                                    <input type="time" id="hora_limite" name="hora_limite" title="Hora de inicio">
                                    <input type="time" id="hora_fin" name="hora_fin" title="Hora de fin">
                                </div>
                            </div>
                        </div>
                        <div id="fecha-rango-section" class="hidden">
                            <p class="form-subtitle">Para eventos que duran varios d√≠as (vacaciones, conferencias, etc.).</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fecha_inicio">Fecha de Inicio</label>
                                    <input type="date" id="fecha_inicio" name="fecha_inicio">
                                </div>
                                <div class="form-group">
                                    <label for="fecha_fin">Fecha de Fin</label>
                                    <input type="date" id="fecha_fin" name="fecha_fin">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="hora_inicio">Hora de Inicio (Opcional)</label>
                                    <input type="time" id="hora_inicio" name="hora_inicio">
                                </div>
                                <div class="form-group">
                                    <label for="hora_fin_rango">Hora de Fin (Opcional)</label>
                                    <input type="time" id="hora_fin_rango" name="hora_fin_rango">
                                </div>
                            </div>
                        </div>
                        <div id="fecha-recurrente-section" class="hidden">
                            <p class="form-subtitle">Para rutinas y h√°bitos que se repiten en d√≠as concretos de la semana.</p>
                            <div class="form-group">
                                <label>D√≠as de la semana</label>
                                <div class="weekdays-selector">
                                    <input type="checkbox" id="dia-1" name="dias_semana" value="1"><label for="dia-1">L</label>
                                    <input type="checkbox" id="dia-2" name="dias_semana" value="2"><label for="dia-2">M</label>
                                    <input type="checkbox" id="dia-3" name="dias_semana" value="3"><label for="dia-3">X</label>
                                    <input type="checkbox" id="dia-4" name="dias_semana" value="4"><label for="dia-4">J</label>
                                    <input type="checkbox" id="dia-5" name="dias_semana" value="5"><label for="dia-5">V</label>
                                    <input type="checkbox" id="dia-6" name="dias_semana" value="6"><label for="dia-6">S</label>
                                    <input type="checkbox" id="dia-0" name="dias_semana" value="0"><label for="dia-0">D</label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fecha_inicio_recurrente">Desde la fecha</label>
                                    <input type="date" id="fecha_inicio_recurrente" name="fecha_inicio_recurrente">
                                </div>
                                <div class="form-group">
                                    <label for="fecha_fin_recurrente">Hasta la fecha</label>
                                    <input type="date" id="fecha_fin_recurrente" name="fecha_fin_recurrente">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="hora_recurrente">Hora de inicio</label>
                                    <input type="time" id="hora_recurrente" name="hora_recurrente">
                                </div>
                                <div class="form-group">
                                    <label for="hora_fin_recurrente">Hora de fin (Opcional)</label>
                                    <input type="time" id="hora_fin_recurrente" name="hora_fin_recurrente">
                                </div>
                            </div>
                        </div>
                        <div class="calendar-section">
                            <div class="main-checkbox">
                                <input type="checkbox" id="add_to_calendar" name="add_to_calendar">
                                <label for="add_to_calendar">A√±adir a Google Calendar</label>
                            </div>
                            <div id="calendarOptions" class="hidden" style="margin-top: 15px;">
                                <label>Opciones de recordatorio:</label>
                                <div class="checkbox-group" style="margin-top: 10px;">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="recordatorio_2h" name="recordatorio_2h">
                                        <label for="recordatorio_2h">2 horas antes</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="recordatorio_custom" name="recordatorio_custom">
                                        <label for="recordatorio_custom">Personalizado</label>
                                    </div>
                                </div>
                                <div id="customReminderFields" class="hidden" style="margin-top: 15px;">
                                    <label>Fecha y hora del recordatorio:</label>
                                    <div class="datetime-group-reminder">
                                        <input type="date" id="recordatorio_fecha" name="recordatorio_fecha">
                                        <input type="time" id="recordatorio_hora" name="recordatorio_hora">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <div id="messageBoxForm"></div>
                    <button type="submit" class="submit-btn" id="submitBtn"><span>Crear Tarea</span></button>
                </form>
            </div>

            <!-- PESTA√ëA 2: GESTOR DE TAREAS -->
            <div id="gestor" class="tab-content">
                <div id="project-details-container" class="hidden"></div>
                <div class="filters-panel">
                    <div class="form-group">
                        <label for="filter-project">Proyecto</label>
                        <select id="filter-project"><option value="all">Todos los proyectos</option></select>
                    </div>
                    <div class="form-group">
                        <label for="filter-area">√Årea</label>
                        <select id="filter-area" multiple size="4" style="padding: 0;"></select>
                    </div>
                    <div class="form-group">
                        <label for="filter-date">Fecha</label>
                        <select id="filter-date">
                            <option value="all">Cualquier fecha</option>
                            <option value="today">Hoy</option>
                            <option value="week">Esta semana</option>
                            <option value="month">Este mes</option>
                            <option value="custom">Personalizado...</option>
                        </select>
                        <div id="custom-date-filter" class="hidden">
                            <div><label for="start-date">Desde: </label><input type="date" id="start-date"></div>
                            <div><label for="end-date">Hasta: </label><input type="date" id="end-date"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="sort-tasks">Ordenar por</label>
                        <select id="sort-tasks">
                            <option value="default">Por defecto</option>
                            <option value="priority">Prioridad</option>
                            <option value="deadline">Fecha l√≠mite</option>
                            <option value="status">Estado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sort-direction">Direcci√≥n</label>
                        <select id="sort-direction">
                            <option value="ascending">Ascendente</option>
                            <option value="descending">Descendente</option>
                        </select>
                    </div>
                </div>
                <div id="task-list-container" class="loading-container"></div>
            </div>

            <!-- PESTA√ëA 3: GESTOR DE PROYECTOS -->
            <div id="proyectos" class="tab-content">
                <h2 class="section-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>Gesti√≥n de Proyectos</h2>
                <div id="project-editor-container" class="hidden"></div>
                <button id="create-project-btn" class="action-btn" style="width: auto; margin-bottom: 20px;">+ Crear Nuevo Proyecto</button>
                <div id="create-project-form-container" class="hidden">
                    <form id="create-project-form">
                        <div class="form-group">
                            <label for="new-project-name">Nombre del Proyecto *</label>
                            <input type="text" id="new-project-name" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-project-status">Estado</label>
                                <select id="new-project-status">
                                    <option>Planificaci√≥n</option>
                                    <option selected>Activo</option>
                                    <option>En Pausa</option>
                                    <option>Terminado</option>
                                    <option>Cancelado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new-project-start-date">Fecha de Inicio</label>
                                <input type="date" id="new-project-start-date">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="new-project-observations">Observaciones</label>
                            <textarea id="new-project-observations"></textarea>
                        </div>
                        <button type="submit" class="submit-btn" style="width: auto; font-size: 1em; padding: 10px 20px;">Guardar Proyecto</button>
                    </form>
                </div>
                <div id="projects-list-container" class="loading-container" style="margin-top: 20px;"></div>
            </div>

            <!-- PESTA√ëA 4: AGENDA -->
            <div id="agenda" class="tab-content">
                <div class="filters-panel">
                    <div class="form-group">
                        <label for="filter-agenda-project">Filtrar por Proyecto</label>
                        <select id="filter-agenda-project"><option value="all">Todos los proyectos</option></select>
                    </div>
                    <div class="form-group">
                        <label for="filter-agenda-area">Filtrar por √Årea</label>
                        <select id="filter-agenda-area"><option value="all">Todas las √°reas</option></select>
                    </div>
                </div>
                <div id="calendar-container">
                    <div id="calendar"></div>
                </div>
            </div>

            <!-- PESTA√ëA 5: AN√ÅLISIS (NUEVA ESTRUCTURA) -->
            <div id="analisis" class="tab-content">
                <nav class="sub-tab-navigation">
                    <button class="sub-tab-btn active" data-subtab="analisis-global">Visi√≥n Global</button>
                    <button class="sub-tab-btn" data-subtab="analisis-proyecto">Por Proyecto</button>
                    <button class="sub-tab-btn" data-subtab="analisis-temporal">Temporal</button>
                </nav>

                <!-- Sub-pesta√±a 1: Visi√≥n Global -->
                <div id="analisis-global" class="sub-tab-content active">
                    <h2 class="section-title" style="border: none; margin-bottom: 20px;">Progreso General de Proyectos Activos</h2>
                    <div id="global-vision-container" class="loading-container"></div>
                </div>

                <!-- Sub-pesta√±a 2: An√°lisis por Proyecto -->
                <div id="analisis-proyecto" class="sub-tab-content">
                    <div class="filters-panel">
                        <div class="form-group">
                            <label for="project-analysis-selector">Seleccionar Proyecto</label>
                            <select id="project-analysis-selector"></select>
                        </div>
                    </div>
                    <div id="project-analysis-dashboard" class="hidden">
                        <div id="heatmap-container" class="chart-card" style="margin-bottom: 20px;"></div>
                        <div class="analysis-grid" style="margin-top: 20px;">
                            <div id="project-tasks-by-status" class="chart-card"></div>
                            <div id="project-priority-chart-container" class="chart-card">
                                <canvas id="project-priority-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sub-pesta√±a 3: An√°lisis Temporal -->
                <div id="analisis-temporal" class="sub-tab-content">
                    <div class="filters-panel">
                         <div class="form-group">
                            <label for="temporal-project-selector">Filtrar Proyectos</label>
                            <select id="temporal-project-selector" multiple></select>
                        </div>
                        <div class="form-group">
                            <label for="temporal-date-filter">Periodo</label>
                            <select id="temporal-date-filter">
                                <option value="today">Hoy</option>
                                <option value="week" selected>Esta Semana</option>
                                <option value="month">Este Mes</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div id="temporal-custom-date-fields" class="form-group hidden" style="display: flex; gap: 10px;">
                            <input type="date" id="temporal-start-date">
                            <input type="date" id="temporal-end-date">
                        </div>
                    </div>
                    <div id="temporal-analysis-dashboard">
                        <!-- Los resultados se cargar√°n aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- PESTA√ëA 6: AJUSTES -->
            <div id="ajustes" class="tab-content">
                <section class="form-section">
                    <h2 class="section-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>Gestionar √Åreas</h2>
                    <p>Aqu√≠ puedes eliminar las √°reas que ya no necesites. Para a√±adir una nueva, simplemente selecci√≥na "+ Otra..." en el formulario de creaci√≥n de tareas.</p>
                    <div id="areas-management-container" style="margin-top: 20px;">
                        <ul id="areas-list"></ul>
                    </div>
                </section>
                <section class="form-section">
                    <h2 class="section-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z"/></svg>Gestionar Calendarios P√∫blicos</h2>
                    <p>A√±ade calendarios externos (festivos, escolares, etc.) usando su direcci√≥n p√∫blica en formato iCal (.ics).</p>
                    <div id="public-calendars-management-container" style="margin-top: 20px;">
                        <ul id="public-calendars-list"></ul>
                        <form id="add-public-calendar-form" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="new-cal-name">Nombre del Calendario</label>
                                    <input type="text" id="new-cal-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="new-cal-color">Color</label>
                                    <input type="color" id="new-cal-color" value="#D81B60">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="new-cal-url">URL del Calendario (.ics)</label>
                                <input type="url" id="new-cal-url" required>
                            </div>
                            <button type="submit" class="submit-btn" style="width: auto; padding: 10px 20px; font-size: 1em;">A√±adir Calendario</button>
                        </form>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal para detalles de la tarea -->
    <div id="task-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button id="modal-close" class="modal-close">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
            <div class="modal-footer">
                <div class="footer-left">
                    <button id="modal-delete-btn" class="delete-btn">Eliminar</button>
                </div>
                <div class="footer-right">
                    <a id="modal-notion-link" href="#" target="_blank" rel="noopener noreferrer">Ver en Notion</a>
                    <button id="modal-save-btn">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

<script>
// ===================================
// SCRIPT DE LA APLICACI√ìN V49.1
// ===================================
const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbzGIpRW2K9ZfCpKRiRKcOEdQDDvuEaVphsopnHvdtrqS-NBY77byzHo6Z1RUTTmgHdi7g/exec';

// --- DEFINICIONES Y CACH√â ---
const ICONS = {
    STATUS: { 'Sin empezar': '‚ö™', 'En progreso': 'üîµ', 'Listo': 'üü¢' },
    PRIORITY: { 'Alta': 'üî∫', 'Medio': 'üî∏', 'Baja': 'üîπ' },
    AREA: { 'Profesional': 'üíº', 'Acad√©mico': 'üéì', 'Personal': 'üë§', 'Salud': '‚ù§Ô∏è', 'Hogar': 'üè†', 'Formaci√≥n': 'üìö', 'Taller': 'üõ†Ô∏è', 'Default': 'üìÅ' }
};

let projectsCache = [];
let allProjectsCache = [];
let areasCache = [];
let publicCalendarsCache = [];
let calendar;
let activeCharts = {}; 
let projectTasksCache = {}; 

document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
    setupEventListeners();
    populateStaticSelects();
    await Promise.all([
        loadProjects(true), 
        loadProjects(false, 'project-analysis-selector'),
        loadProjects(false, 'temporal-project-selector'),
        loadAreas(),
        loadPublicCalendars()
    ]);
    await loadTasks();
    initializeCalendar();
}

function setupEventListeners() {
    // ... (El c√≥digo de los listeners se acorta por brevedad, es id√©ntico a la v48)
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.dataset.tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            if (tabId === 'agenda' && calendar) setTimeout(() => calendar.render(), 10);
            if (tabId === 'proyectos') renderProjectsList();
            if (tabId === 'analisis') {
                const globalContainer = document.getElementById('global-vision-container');
                if (globalContainer.innerHTML.trim() === '' || globalContainer.classList.contains('loading-container')) {
                    loadGlobalVision();
                }
                const projectAnalysisContainer = document.getElementById('project-analysis-dashboard');
                if(projectAnalysisContainer.classList.contains('hidden')){
                    loadProjectAnalysisDashboard();
                }
                 const temporalAnalysisContainer = document.getElementById('temporal-analysis-dashboard');
                if(temporalAnalysisContainer.innerHTML.trim() === ''){
                     loadTemporalAnalysisDashboard();
                }
            }
            if (tabId === 'ajustes') {
                renderAreasManagement();
                renderPublicCalendarsManagement();
            }
        });
    });

    document.querySelectorAll('.sub-tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            const subtabId = button.dataset.subtab;
            button.closest('.sub-tab-navigation').querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            button.closest('.tab-content').querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(subtabId).classList.add('active');
        });
    });
    
    document.getElementById('global-vision-container').addEventListener('click', (e) => {
        const taskElement = e.target.closest('li[data-task-id]');
        if (taskElement) {
            const taskId = taskElement.dataset.taskId;
            const projectId = taskElement.closest('.project-tasks-details').id.replace('project-tasks-', '');
            const task = projectTasksCache[projectId]?.find(t => t.id === taskId);
            if (task) {
                showTaskModal({ extendedProps: task });
            }
        }
    });
    
    document.getElementById('project-analysis-dashboard').addEventListener('click', (e) => {
        const taskElement = e.target.closest('li[data-task-id]');
        if (taskElement) {
            const taskId = taskElement.dataset.taskId;
            const projectId = document.getElementById('project-analysis-selector').value;
            const task = projectTasksCache[projectId]?.find(t => t.id === taskId);
            if (task) {
                showTaskModal({ extendedProps: task });
            }
        }
    });
    
     document.getElementById('temporal-analysis-dashboard').addEventListener('click', (e) => {
        const taskElement = e.target.closest('li[data-task-id]');
        if (taskElement) {
            const taskId = taskElement.dataset.taskId;
             const temporalTasks = JSON.parse(e.currentTarget.dataset.tasks || '[]');
            const task = temporalTasks.find(t => t.id === taskId);
            if (task) {
                showTaskModal({ extendedProps: task });
            }
        }
    });
    
    document.getElementById('project-analysis-selector').addEventListener('change', loadProjectAnalysisDashboard);
    const temporalFilters = ['temporal-project-selector', 'temporal-date-filter', 'temporal-start-date', 'temporal-end-date'];
    temporalFilters.forEach(id => document.getElementById(id).addEventListener('change', loadTemporalAnalysisDashboard));
    document.getElementById('temporal-date-filter').addEventListener('change', e => {
        document.getElementById('temporal-custom-date-fields').classList.toggle('hidden', e.target.value !== 'custom');
    });

    // ... (resto de listeners)
}

// ... (El resto del script se mantiene igual, con las correcciones ya aplicadas en la v48)

</script>

</body>
</html>
